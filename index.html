<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>cartongesso</title>
    <link rel="stylesheet" type="text/css" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">
    <style type="text/css">
      body {
        margin-top: 40px;
      }
      .panel-heading {
        line-height: 56px;
      }
      .panel-heading h3 {
        display: inline-block;
      }
      .panel-heading .row > * {
        margin: 0 10px;
      }
      .form-group {
        padding: 15px 0;
      }
      .form-group > label:after {
        content: ":";
      }
      .input-group {
        padding: 5px 0;
      }
      .panel-footer .alert {
        display: inline-block;
        margin-left: 20px;
      }
    </style>
  </head>
  <body>

    <div class="container">

      <form class="form-horizontal" role="form" name="inputs">
        <div class="panel panel-default">
          <div class="panel-heading">
            <div class="row">
              <h3>Calcolo prezzo cartongesso</h3>
              <div class="pull-right">
                <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#settingsModal">
                  <span class="glyphicon glyphicon-cog"></span> Impostazioni
                </button>
              </div>
            </div>
          </div>
          <div class="panel-body">

            <div class="form-group">
              <label class="col-sm-2 control-label">Montante</label>
              <div class="col-sm-10">
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="montante" value="30" checked>
                    30
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="montante" value="50">
                    50
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="montante" value="75">
                    75
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="montante" value="100">
                    100
                  </label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="col-sm-2 control-label">Guida</label>
              <div class="col-sm-10">
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="guida" value="30" checked>
                    30
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="guida" value="50">
                    50
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="guida" value="75">
                    75
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="guida" value="100">
                    100
                  </label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="col-sm-2 control-label">Lastra</label>
              <div class="col-sm-10">
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="lastra" value="cartongesso" checked>
                    Cartongesso
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="lastra" value="idrolastra">
                    Idrolastra
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="lastra" value="ignilastra">
                    Ignilastra
                  </label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="col-sm-2 control-label">Parete</label>
              <div class="col-sm-10">
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="parete" value="1+1" checked>
                    1+1
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="parete" value="1+2">
                    1+2
                  </label>
                </div>
                <div class="radio-inline">
                  <label>
                    <input type="radio" name="parete" value="2+2">
                    2+2
                  </label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="col-sm-2 control-label">Dimensioni</label>
              <div class="col-sm-10">
                <div class="input-group col-sm-4">
                  <span class="input-group-addon">base</span>
                  <input type="number" class="form-control" placeholder="inserisci base" name="base">
                  <span class="input-group-addon">metri</span>
                </div>
                <div class="input-group col-sm-4">
                  <span class="input-group-addon">altezza</span>
                  <input type="number" class="form-control" placeholder="inserisci altezza" name="altezza">
                  <span class="input-group-addon">metri</span>
                </div>
              </div>
            </div>

          </div>
          <div class="panel-footer text-right">
            <div class="alert alert-danger pull-right" role="alert" style="display: none">Attenzione: impostazioni mancanti</div>
            <p class="h3">Totale: <span id="total">0</span> &euro;</p>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="modalLabel">Impostazioni</h4>
          </div>
          <div class="modal-body">
            <form name="settings">

              <div class="form-group row">
                <label class="col-sm-3 control-label text-right">Montante</label>
                <div class="col-sm-7">
                  <div class="input-group">
                    <span class="input-group-addon">30</span>
                    <input type="number" name="m30price" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m</span>
                  </div>
                  <div class="input-group">
                    <span class="input-group-addon">50</span>
                    <input type="number" name="m50price" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m</span>
                  </div>
                  <div class="input-group">
                    <span class="input-group-addon">75</span>
                    <input type="number" name="m75price" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m</span>
                  </div>
                  <div class="input-group">
                    <span class="input-group-addon">100</span>
                    <input type="number" name="m100price" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m</span>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-sm-3 control-label text-right">Guida</label>
                <div class="col-sm-7">
                  <div class="input-group">
                    <span class="input-group-addon">30</span>
                    <input type="number" name="g30price" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m</span>
                  </div>
                  <div class="input-group">
                    <span class="input-group-addon">50</span>
                    <input type="number" name="g50price" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m</span>
                  </div>
                  <div class="input-group">
                    <span class="input-group-addon">75</span>
                    <input type="number" name="g75price" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m</span>
                  </div>
                  <div class="input-group">
                    <span class="input-group-addon">100</span>
                    <input type="number" name="g100price" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m</span>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-sm-3 control-label text-right">Lastra</label>
                <div class="col-sm-7">
                  <div class="input-group">
                    <span class="input-group-addon">cartongesso</span>
                    <input type="number" name="lcrtprice" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m&sup2;</span>
                  </div>
                  <div class="input-group">
                    <span class="input-group-addon">idrolastra</span>
                    <input type="number" name="lidrprice" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m&sup2;</span>
                  </div>
                  <div class="input-group">
                    <span class="input-group-addon">ignilastra</span>
                    <input type="number" name="lignprice" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m&sup2;</span>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-sm-3 control-label text-right">Vite</label>
                <div class="col-sm-7">
                  <div class="input-group">
                    <span class="input-group-addon">prezzo</span>
                    <input type="number" name="vitprice" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / cad</span>
                  </div>
                  <div class="input-group">
                    <span class="input-group-addon">distanza</span>
                    <input type="number" name="vitdistance" class="form-control" placeholder="inserisci misura">
                    <span class="input-group-addon">m</span>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-sm-3 control-label text-right">Stucco</label>
                <div class="col-sm-7">
                  <div class="input-group">
                    <input type="number" name="stcprice" class="form-control" placeholder="inserisci prezzo">
                    <span class="input-group-addon">&euro; / m&sup2;</span>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-sm-3 control-label text-right">Interasse</label>
                <div class="col-sm-7">
                  <div class="input-group">
                    <input type="number" name="interasse" class="form-control" placeholder="inserisci misura">
                    <span class="input-group-addon">m</span>
                  </div>
                </div>
              </div>

            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Chiudi</button>
          </div>
        </div>
      </div>
    </div>

    <script src="./bower_components/jquery/dist/jquery.min.js"></script>
    <script src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script>

      function getCurrencyValue(value) {
        return Math.round(Number(value) * 100) / 100;
      }

      function getFormsValues() {
        return {
          inputs: $(inputs).serializeArray(),
          settings: $(settings).serializeArray()
        }
      }

      function setFormsValues(forms) {
        for (var i = 0, len = forms.inputs.length; i < len; i++) {
          inputs[forms.inputs[i].name].value = forms.inputs[i].value;
        }
        for (var i = 0, len = forms.settings.length; i < len; i++) {
          settings[forms.settings[i].name].value = forms.settings[i].value;
        }
      }

      function getInputValues() {
        return {
          montante : inputs.montante.value,
          guida    : inputs.guida.value,
          lastra   : inputs.lastra.value,
          npareti  : inputs.parete.value,
          base     : Number(inputs.base.value),
          altezza  : Number(inputs.altezza.value),

          mprice : {
            30  : getCurrencyValue(settings.m30price.value),
            50  : getCurrencyValue(settings.m50price.value),
            75  : getCurrencyValue(settings.m75price.value),
            100 : getCurrencyValue(settings.m100price.value)
          },

          gprice : {
            30  : getCurrencyValue(settings.g30price.value),
            50  : getCurrencyValue(settings.g50price.value),
            75  : getCurrencyValue(settings.g75price.value),
            100 : getCurrencyValue(settings.g100price.value)
          },

          lprice : {
            cartongesso : getCurrencyValue(settings.lcrtprice.value),
            idrolastra  : getCurrencyValue(settings.lidrprice.value),
            ignilastra  : getCurrencyValue(settings.lignprice.value)
          },

          vitprice  : getCurrencyValue(settings.vitprice.value),
          vitdistance : Number(settings.vitdistance.value),
          interasse : Number(settings.interasse.value),

          stcprice : getCurrencyValue(settings.stcprice.value)
        }
      }

      function normalize(inputs) {
        var npareti = inputs.npareti === '1+1' ? 2 :
            inputs.npareti === '1+2' ? 3 :
                inputs.npareti === '2+2' ? 4 : 0;
        inputs.npareti = npareti;

        var mprice = inputs.mprice[inputs.montante];
        inputs.mprice = mprice;

        var gprice = inputs.gprice[inputs.guida];
        inputs.gprice = gprice;

        var lprice = inputs.lprice[inputs.lastra];
        inputs.lprice = lprice;

        return inputs;
      }

      function calculateTotalPrice(inputs) {
        var area = inputs.base * inputs.altezza;

        // total montanti
        var ptotmontanti = getCurrencyValue(
          area * inputs.mprice / inputs.interasse
        );

        // total guide
        var ptotguide = getCurrencyValue(
          2 * (inputs.base + inputs.altezza) * inputs.gprice
        );

        // total lastra
        var ptotlastra = getCurrencyValue(
          area * inputs.lprice * inputs.npareti
        );

        // total viti
        var ptotviti = getCurrencyValue(
          (area * inputs.vitprice) / (inputs.interasse * inputs.vitdistance)
        );

        // total stucco
        var ptotstucco = getCurrencyValue(
          area * inputs.stcprice
        );

        // console.log("ptotmontanti:"+ptotmontanti,
        //     "ptotguide:"+ptotguide,
        //     "ptotlastra:"+ptotlastra,
        //     "ptotviti:"+ptotviti,
        //     "ptotstucco:"+ptotstucco);

        return ptotmontanti + ptotguide + ptotlastra + ptotviti + ptotstucco;
      }

      function updateTotal(){
        var inputs = getInputValues(),
            parameters = normalize(inputs);

        var total = calculateTotalPrice(parameters);
        if (isNaN(total)) {
          $('#total').closest('.panel-footer').find('.alert').show();
        }
        else {
          $('#total').closest('.panel-footer').find('.alert').hide();
          $('#total').html(total);
        }
      }

      function loadLocalStorage(){
        var forms;
        if (forms = window.localStorage.getItem('forms')) {
          setFormsValues(JSON.parse(forms));
          return true;
        }
        return false;
      }

      $(document).ready(function(){

        loadLocalStorage() && updateTotal();

        // trigger radio changes
        $('form').find(':radio').change(function(){
          var forms = getFormsValues();
          window.localStorage.setItem('forms', JSON.stringify(forms));
          updateTotal();
        });
        // filter input number chars
        $('form').find('input[type=number]').on('keypress', function(e){
          var ch = String.fromCharCode(e.which);
          if (!/\d|\./.test(ch)) {
            e.preventDefault();
          }
        });
        // trigger input number changes
        $('form').find('input[type=number]').keyup(function(e){
          var forms = getFormsValues();
          window.localStorage.setItem('forms', JSON.stringify(forms));
          updateTotal();
        });

      });
    </script>
  </body>
</html>
